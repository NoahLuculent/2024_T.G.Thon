<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>느린 우체통</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/view.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <h2>내게 온 편지 확인</h2>
      <div class="search-container">
        <input type="text" id="search-input" placeholder="보낸 이 검색하기" />
        <select id="filter">
          <option value="latest">최신순</option>
          <option value="oldest">오래된 순</option>
        </select>
      </div>
      <div id="letter-list">
        <!-- 편지 목록이 여기에 동적으로 추가됩니다. -->
        {% for letter in letters %}
        <div
          class="letter"
          data-sender="{{ letter['sender_name'] }}"
          data-original-index="{{ loop.index0 }}"
          anonymous="{{ letter['anonymous'] }}"
        >
          <div class="letter-title">{{ letter['letter_title'] }}</div>
          <div class="letter-timer" data-time="{{ letter['time'] }}">
            {{ letter['time'] }} left
          </div>
          <div class="letter-preview hidden">{{ letter['preview'] }}</div>
          <button class="open-button hidden" onclick="openLetter(this)">
            편지 열기
          </button>
        </div>
        {% endfor %}
      </div>
      <!-- 뒤로가기 버튼 -->
      <button type="button" id="back-button" onclick="location.href='select'">
        뒤로가기
      </button>
    </div>

    <script src="{{ url_for('static', filename='js/view.js') }}" defer></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        fetch("/api/letters")
          .then((response) => response.json())
          .then((letters) => {
            const letterList = document.getElementById("letter-list");
            letterList.innerHTML = ""; // 초기화

            letters.forEach((letter) => {
              const letterDiv = document.createElement("div");
              letterDiv.className = "letter";
              letterDiv.setAttribute("data-sender", letter.id);

              const letterHeader = document.createElement("div");
              letterHeader.className = "letter-header";

              const starDiv = document.createElement("div");
              starDiv.className = "star";
              starDiv.setAttribute("onclick", "toggleFavorite(this)");

              const letterInfo = document.createElement("div");
              letterInfo.className = "letter-info";

              const letterTitle = document.createElement("p");
              letterTitle.className = "letter-title";
              letterTitle.textContent = letter.title;

              const letterPreview = document.createElement("p");
              letterPreview.className = "letter-preview hidden";
              letterPreview.textContent = "편지 미리보기";

              const letterTimer = document.createElement("div");
              letterTimer.className = "letter-timer";
              letterTimer.setAttribute("data-time", letter.time_left);
              letterTimer.setAttribute("data-sender", letter.id);
              letterTimer.textContent = `${letter.time_left} left`;

              const openButton = document.createElement("button");
              openButton.className = "open-button";
              openButton.textContent = "열람 가능";
              openButton.setAttribute("onclick", "openLetter(this)");

              // 열람 가능 여부에 따라 버튼 표시
              if (!letter.can_open) {
                openButton.classList.add("hidden");
              }

              letterInfo.appendChild(letterTitle);
              letterInfo.appendChild(letterPreview);
              letterHeader.appendChild(starDiv);
              letterHeader.appendChild(letterInfo);
              letterDiv.appendChild(letterHeader);
              letterDiv.appendChild(letterTimer);
              letterDiv.appendChild(openButton);

              letterList.appendChild(letterDiv);
            });
          });
      });

      function openLetter(button) {
        // letter.html로 이동
        const urlParams = new URLSearchParams(window.location.search);
        const letterId = urlParams.get("letter_id");
        fetch(`/letter/${letterId}`)
          .then((response) => response.json())
          .then((data) => {
            if (data.error) {
              alert(data.error);
            } else {
              document.getElementById("letter-title").textContent = data.title;
              document.getElementById("sent-date").textContent =
                "보낸 날짜: " + data.sent_date;
              document.getElementById("received-date").textContent =
                "받은 날짜: " + data.received_date;
              document.getElementById("sender-name").textContent =
                "보낸 이: " + data.sender;
              document.getElementById("letter-content").textContent =
                data.content;
            }
          })
          .catch((error) => {
            alert("편지를 불러오는 중 오류가 발생했습니다.");
          });

        window.location.href =
          "{{ url_for('letter_page', letter_id=letterId) }}";
      }
    </script>
  </body>
</html>
